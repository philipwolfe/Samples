



    <link rel="stylesheet" href="../../../../util/style.css">

    <form name="Form" method="post" action="srcview.htm?path=/QuickStart/aspplus/samples/portal/portal.src&file=personalization/Personalization.cs" id="Form">
<input type="hidden" name="__VIEWSTATE" value="YTB6MTQ3MzAyNjM4MF9hMHpfaHo1ejN4X2Ewel9oejV6MHhfYTB6aHppbm5lcmh0bWxfcGVyc29uYWxpXHphdGlvbi9QZXJzb25hbGlcemF0aW9uLmNzeF9feHhfeHhfeF9feA==c9d20564" />


        <div class="SampleHeader" style="width:100%">
            <div class="SampleTitle">
                <span id="Title">personalization/Personalization.cs</span>
            </div>
            <table id="SourceTable" style="font: 8pt Verdana">
    <tr>
        <td style="padding-right:10;"><b><nobr>Unrestricted Pages</nobr>: </b></td>
        <td><a href='../../../../aspplus/samples/portal/defaultaspxsource.htm'>default.htm</a> &nbsp;&nbsp<a href='../../../../aspplus/samples/portal/loginaspxsource.htm'>login.htm</a> &nbsp;&nbsp<a href='../../../../aspplus/samples/portal/useraspxsource.htm'>user.htm</a> &nbsp;&nbsp<a href='../../../../aspplus/samples/portal/congratsaspxsource.htm'>congrats.htm</a> &nbsp;&nbsp<a href='../../../../aspplus/samples/portal/constraspxsource.htm'>constr.htm</a> &nbsp;&nbsp<a href='../../../../aspplus/samples/portal/configwebsource.htm'>config.web</a> &nbsp;&nbsp</td>
    </tr>
    <tr>
        <td style="padding-right:10;"><b><nobr>Restricted Pages</nobr>: </b></td>
        <td><a href='../../../../aspplus/samples/portal/restricted/customizeaspxsource.htm'>restricted/customize.htm</a> &nbsp;&nbsp<a href='../../../../aspplus/samples/portal/restricted/deletepageaspxsource.htm'>restricted/deletepage.htm</a> &nbsp;&nbsp<a href='../../../../aspplus/samples/portal/restricted/layoutaspxsource.htm'>restricted/layout.htm</a> &nbsp;&nbsp<a href='../../../../aspplus/samples/portal/restricted/optionsaspxsource.htm'>restricted/options.htm</a> &nbsp;&nbsp<a href='../../../../aspplus/samples/portal/restricted/configwebsource.htm'>restricted/config.web</a> &nbsp;&nbsp</td>
    </tr>
    <tr>
        <td style="padding-right:10;"><b><nobr>Personalization Module</nobr>: </b></td>
        <td><a href='../../../../aspplus/samples/portal/personalization/personalizationcssource.htm'>personalization/Personalization.cs</a> &nbsp;&nbsp<a href='../../../../aspplus/samples/portal/personalization/portalmodulecssource.htm'>personalization/PortalModule.cs</a> &nbsp;&nbsp<a href='../../../../aspplus/samples/portal/personalization/makesamplebatsource.htm'>personalization/makesample.bat</a> &nbsp;&nbsp</td>
    </tr>
    <tr>
        <td style="padding-right:10;"><b><nobr>Stored Procedures</nobr>: </b></td>
        <td><a href='../../../../aspplus/samples/portal/data/portalsqlsource.htm'>data/portal.sql</a> &nbsp;&nbsp</td>
    </tr>
    <tr>
        <td style="padding-right:10;"><b><nobr>Login Module</nobr>: </b></td>
        <td><a href='../../../../aspplus/samples/portal/modules/login/loginascxsource.htm'>modules/login/login.ascx</a> &nbsp;&nbsp</td>
    </tr>
    <tr>
        <td style="padding-right:10;"><b><nobr>BookOfTheDay Module</nobr>: </b></td>
        <td><a href='../../../../aspplus/samples/portal/modules/bookoftheday/bookofthedayascxsource.htm'>modules/bookoftheday/bookoftheday.ascx</a> &nbsp;&nbsp<a href='../../../../aspplus/samples/portal/modules/bookoftheday/bookoftheday_demoaspxsource.htm'>modules/bookoftheday/bookoftheday_demo.htm</a> &nbsp;&nbsp</td>
    </tr>
    <tr>
        <td style="padding-right:10;"><b><nobr>SiteDirectory Module</nobr>: </b></td>
        <td><a href='../../../../aspplus/samples/portal/modules/sitedirectory/sitedirectoryascxsource.htm'>modules/sitedirectory/sitedirectory.ascx</a> &nbsp;&nbsp<a href='../../../../aspplus/samples/portal/modules/sitedirectory/sitedirectory_demoaspxsource.htm'>modules/sitedirectory/sitedirectory_demo.htm</a> &nbsp;&nbsp<a href='../../../../aspplus/samples/portal/modules/sitedirectory/sitedirectory_editaspxsource.htm'>modules/sitedirectory/sitedirectory_edit.htm</a> &nbsp;&nbsp</td>
    </tr>
    <tr>
        <td style="padding-right:10;"><b><nobr>Welcome Module</nobr>: </b></td>
        <td><a href='../../../../aspplus/samples/portal/modules/welcome/welcomeascxsource.htm'>modules/welcome/welcome.ascx</a> &nbsp;&nbsp<a href='../../../../aspplus/samples/portal/modules/welcome/welcome_demoaspxsource.htm'>modules/welcome/welcome_demo.htm</a> &nbsp;&nbsp</td>
    </tr>
    <tr>
        <td style="padding-right:10;"><b><nobr>LocalNews Module</nobr>: </b></td>
        <td><a href='../../../../aspplus/samples/portal/modules/static/localnewsascxsource.htm'>modules/static/localnews.ascx</a> &nbsp;&nbsp<a href='../../../../aspplus/samples/portal/modules/static/localnews_demoaspxsource.htm'>modules/static/localnews_demo.htm</a> &nbsp;&nbsp</td>
    </tr>
    <tr>
        <td style="padding-right:10;"><b><nobr>WorldNews Module</nobr>: </b></td>
        <td><a href='../../../../aspplus/samples/portal/modules/static/worldnewsascxsource.htm'>modules/static/worldnews.ascx</a> &nbsp;&nbsp<a href='../../../../aspplus/samples/portal/modules/static/worldnews_demoaspxsource.htm'>modules/static/worldnews_demo.htm</a> &nbsp;&nbsp</td>
    </tr>
    <tr>
        <td style="padding-right:10;"><b><nobr>Weather Module</nobr>: </b></td>
        <td><a href='../../../../aspplus/samples/portal/modules/static/weatherascxsource.htm'>modules/static/weather.ascx</a> &nbsp;&nbsp<a href='../../../../aspplus/samples/portal/modules/static/weather_demoaspxsource.htm'>modules/static/weather_demo.htm</a> &nbsp;&nbsp</td>
    </tr>
    <tr>
        <td style="padding-right:10;"><b><nobr>FavoriteLinks Module</nobr>: </b></td>
        <td><a href='../../../../aspplus/samples/portal/modules/favoritelinks/favoritelinksascxsource.htm'>modules/favoritelinks/favoritelinks.ascx</a> &nbsp;&nbsp<a href='../../../../aspplus/samples/portal/modules/favoritelinks/favoritelinks_demoaspxsource.htm'>modules/favoritelinks/favoritelinks_demo.htm</a> &nbsp;&nbsp<a href='../../../../aspplus/samples/portal/modules/favoritelinks/favoritelinks_editaspxsource.htm'>modules/favoritelinks/favoritelinks_edit.htm</a> &nbsp;&nbsp<a href='../../../../aspplus/samples/portal/modules/favoritelinks/favoritelinksleftascxsource.htm'>modules/favoritelinks/favoritelinksleft.ascx</a> &nbsp;&nbsp<a href='../../../../aspplus/samples/portal/modules/favoritelinks/favoritelinksleft_demoaspxsource.htm'>modules/favoritelinks/favoritelinksleft_demo.htm</a> &nbsp;&nbsp</td>
    </tr>
    <tr>
        <td style="padding-right:10;"><b><nobr>Include Files</nobr>: </b></td>
        <td><a href='../../../../aspplus/samples/portal/include/editmoduleheaderascxsource.htm'>include/editmoduleheader.ascx</a> &nbsp;&nbsp<a href='../../../../aspplus/samples/portal/include/editmodulefooterascxsource.htm'>include/editmodulefooter.ascx</a> &nbsp;&nbsp<a href='../../../../aspplus/samples/portal/include/leftmoduleheaderascxsource.htm'>include/leftmoduleheader.ascx</a> &nbsp;&nbsp<a href='../../../../aspplus/samples/portal/include/leftmodulefooterascxsource.htm'>include/leftmodulefooter.ascx</a> &nbsp;&nbsp<a href='../../../../aspplus/samples/portal/include/pageheaderascxsource.htm'>include/pageheader.ascx</a> &nbsp;&nbsp<a href='../../../../aspplus/samples/portal/include/leftmoduleheaderascxsource.htm'>include/leftmoduleheader.ascx</a> &nbsp;&nbsp<a href='../../../../aspplus/samples/portal/include/leftmodulefooterascxsource.htm'>include/leftmodulefooter.ascx</a> &nbsp;&nbsp<a href='../../../../aspplus/samples/portal/include/rightmoduleheaderascxsource.htm'>include/rightmoduleheader.ascx</a> &nbsp;&nbsp<a href='../../../../aspplus/samples/portal/include/rightmodulefooterascxsource.htm'>include/rightmodulefooter.ascx</a> &nbsp;&nbsp<a href='../../../../aspplus/samples/portal/include/pagefooterascxsource.htm'>include/pagefooter.ascx</a> &nbsp;&nbsp<a href='../../../../aspplus/samples/portal/include/pagesubheaderascxsource.htm'>include/pagesubheader.ascx</a> &nbsp;&nbsp<a href='../../../../aspplus/samples/portal/include/pagesubfooterascxsource.htm'>include/pagesubfooter.ascx</a> &nbsp;&nbsp</td>
    </tr>
</table>

        </div>

        <xmp>using System;
using System.Collections;
using System.Web; 
using System.Data;
using System.Data.SQL;

namespace Personalization {

    public class UserStateModule : IHttpModule
    {
        public String ModuleName 
        { 
            get { return "PersonalizationModule"; } 
        }    
    
        public void Init(HttpApplication app)
        { 
            app.EndRequest += new EventHandler(this.OnLeave);
            app.AuthenticateRequest += new EventHandler(this.OnEnter);
        }

        public void Dispose()
        {

        }
        public void OnEnter(Object source, EventArgs eventArgs)
        {

            HttpApplication app;
            HttpContext context;

            app = (HttpApplication)source;
            context = app.Context;
          
            String userId = "ANONYMOUS";
            
           if (context.Request.IsAuthenticated ) 
               userId= context.User.Identity.Name ;  
   
           // Obtain Appropriate User state and populate HttpContext with it
           context.Items["UserState"] = new UserState(userId);
        }

        public void OnLeave(Object source, EventArgs eventArgs)
        {

            // Save UserState back to data store
            HttpApplication app;
            HttpContext context;

            app = (HttpApplication)source;
            context = app.Context; 
            UserState myState = (UserState) context.Items["UserState"]; 
            if (myState != null)  
               myState.Save();
        }
    }

    public class UserState {

        private Hashtable   m_userPersonalization = new Hashtable();
        private String      m_userId;
        private bool        m_isdirty;

        public UserState(String UserId) {

            m_userId = UserId;
            SQLDataSetCommand myAdapter = new SQLDataSetCommand();
 
            myAdapter.SelectCommand  = new SQLCommand();
            myAdapter.SelectCommand.ActiveConnection = new SQLConnection("Localhost","sa","","portal");
            myAdapter.SelectCommand.CommandText = "LoadPersonalizationSettings";
            myAdapter.SelectCommand.CommandType = CommandType.StoredProcedure;

            SQLParameter myParameter = new SQLParameter("@UserID", SQLDataType.VarChar,100);
            myParameter.Value = UserId ; 

            myAdapter.SelectCommand.Parameters.Add(myParameter);

            DataSet myDataSet = new DataSet();
            myAdapter.FillDataSet(myDataSet,"Results");
 
           if (myDataSet.Tables[0].Rows.Count == 0) {

                SQLCommand createUserCommand = new SQLCommand(); 
                createUserCommand.ActiveConnection = new SQLConnection("localhost","sa","","portal");
                createUserCommand.ActiveConnection.Open();
                createUserCommand.CommandText = "CreatePersonalizationAccount";
                createUserCommand.CommandType = CommandType.StoredProcedure;
                SQLParameter myUserId = new SQLParameter("@UserID", SQLDataType.VarChar,20) ;
                myUserId.Value = UserId ;
                createUserCommand.Parameters.Add( myUserId);
                createUserCommand.ExecuteNonQuery();

               // Not repopulate user dataset

                myDataSet = new DataSet();
                myAdapter.FillDataSet(myDataSet,"Results");

           }


	    // If user doesn't exist -- create new personalization account

            DataRow myDataRow = myDataSet.Tables[0].Rows[0];
            DataColumn [] columns  = myDataSet.Tables[0].Columns.All;

            for (int i=0; i<columns.Length;i++) {

               Object value = myDataSet.Tables[0].Rows[0][columns[i]];
               m_userPersonalization[columns[i].ToString()] = (value == null) ? "" : value.ToString();
            }

            myAdapter.Dispose();

        }

        public String UserId {
            get {
                return m_userId;
            }
            set {
                m_userId = value;
            }
        } 

        public String this[String key] {
            get {
                return (String) m_userPersonalization[key];
            } 
            set {
                m_userPersonalization[key] = value;
                m_isdirty = true;
            }
        }

        public void Save() {

            if (m_isdirty == true) { 
                SQLConnection conn = new SQLConnection("localhost","sa","","portal");
                SQLCommand cmd = new SQLCommand("SavePersonalizationSettings", conn);
                conn.Open();
      
                IEnumerator  myHashKeyEnum = ((IEnumerable)m_userPersonalization.Keys).GetEnumerator(); 
                IEnumerator  myHashValEnum = ((IEnumerable)m_userPersonalization.Values).GetEnumerator(); 
          

                while( myHashKeyEnum.MoveNext() && myHashValEnum.MoveNext() )
                {
                    SQLParameter myParameter = new SQLParameter("@"+myHashKeyEnum.Current.ToString() , SQLDataType.VarChar,1000);
                    myParameter.Value = myHashValEnum.Current.ToString() ; 
                    cmd.Parameters.Add(myParameter);
                }
                int rowsAffected = 0;
                cmd.CommandType = CommandType.StoredProcedure;
                rowsAffected = cmd.ExecuteNonQuery();
            }
        }
    }
}
</xmp>
        <span id="ErrorMessage" style="color:red"></span>

    </form>
